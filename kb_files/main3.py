import board
from kb import KMKKeyboard, isRight
from kmk.keys import KC
from kmk.modules.layers import Layers
from kmk.modules.split import Split, SplitSide, SplitType
from kmk.extensions.media_keys import MediaKeys
from kmk.modules.tapdance import TapDance
from kmk.modules.holdtap import HoldTap
from kmk.modules.combos import Combos, Chord, Sequence
from kmk.modules.sticky_keys import StickyKeys
from kmk.modules.macros import Macros, Press, Release, Tap
from kmk.modules.sticky_mod import StickyMod

print(f"LOADING PIANTOR {'RIGHT' if isRight else 'LEFT'}...")

'''

I N I T I A L I Z E  K E E B
‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾
'''
keyboard = KMKKeyboard()
keyboard.tap_time = 100
keyboard.extensions.append(MediaKeys())
'''

S P L I T  S E T U P
‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾
'''
split_side = SplitSide.RIGHT if isRight else SplitSide.LEFT
uart_flip = False if isRight else True

data_pin = board.GP1  #RX
data_pin2 = board.GP0 #TX

split = Split(
    split_flip=False,
    split_side=split_side,
    split_type=SplitType.UART,
    split_target_left=True,
    data_pin=data_pin,
    data_pin2=data_pin2,
    uart_flip=uart_flip,
    use_pio=True
)
keyboard.modules.append(split)

'''
C L E A N  K E Y  N A M E S
‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾
'''
XXXXXXX = KC.NO
_______ = KC.TRNS
#KC_MEH  = KC.LCTRL(KC.LSFT(KC.LALT))

'''
L A Y E R S
‾‾‾‾‾‾‾‾‾‾‾‾‾
'''
layers = Layers()
keyboard.modules.append(layers)

LAY_0 = KC.TO(0) # BASE
LAY_1 = KC.MO(1) # NUMS
LAY_2 = KC.MO(2) # NAV
LAY_3 = KC.MO(3) # SYM
LAY_4 = KC.MO(4) # MACROS

LT_SPC_2    = KC.LT(2, KC.SPC,      prefer_hold=False, tap_interrupted=False, tap_time=110)
LT_ENT_3    = KC.LT(3, KC.ENT,      prefer_hold=False, tap_interrupted=False, tap_time=110)

'''
H O L D  T A P
‾‾‾‾‾‾‾‾‾‾‾‾‾‾
'''
holdtap = HoldTap()
keyboard.modules.append(holdtap)
G_OP     = KC.HT(KC.G, KC.LALT, prefer_hold=False, tap_interrupted=False, tap_time=90)

'''
S T I C K Y  K E Y S
‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾
'''
sticky_keys = StickyKeys()
sticky_keys = StickyKeys(release_after=2000)
keyboard.modules.append(sticky_keys)

SK_LCTL = KC.SK(KC.LCTL)
SK_LSFT = KC.SK(KC.LSFT)
SK_LALT = KC.SK(KC.LALT)
SK_LGUI = KC.SK(KC.LGUI)

SK_MEH  = KC.SK(KC.LCTRL(KC.LSFT(KC.LALT)))

SK_LAY2 = KC.SK(LAY_2, defer_release=True)

'''
S T I C K Y  M O D S
‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾
'''
sticky_mod = StickyMod()
keyboard.modules.append(sticky_mod)

SM_D = KC.SM(KC.D, KC.LGUI)
SM_Z = KC.SM(KC.Z, KC.LGUI)
SM_X = KC.SM(KC.X, KC.LGUI)
SM_C = KC.SM(KC.C, KC.LGUI)
SM_V = KC.SM(KC.V, KC.LGUI)

'''
M A C R O S
‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾
'''
macros = Macros()
keyboard.modules.append(macros)

M_CUT = KC.MACRO(
    Press(KC.LCTL),
    Tap(KC.X),
    Release(KC.LCTL)
)

M_COPY = KC.MACRO(
    Press(KC.LCTL),
    Tap(KC.C),
    Release(KC.LCTL)
)

M_PASTE = KC.MACRO(
    Press(KC.LCTL),
    Tap(KC.V),
    Release(KC.LCTL)
)

M_UNDO = KC.MACRO(
    Press(KC.LGUI),
    Tap(KC.Z),
    Release(KC.LGUI)
)

M_T = KC.MACRO(
    Press(KC.LGUI),
    Tap(KC.T),
    Release(KC.LGUI)
)

M_L = KC.MACRO(
    Press(KC.LGUI),
    Tap(KC.L),
    Release(KC.LGUI)
)

M_N = KC.MACRO(
    Press(KC.LGUI),
    Tap(KC.N),
    Release(KC.LGUI)
)

'''
T A P  D A N C E
‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾
'''
tapdance = TapDance()
tapdance.tap_time = 180
keyboard.modules.append(tapdance)

LAY2_SPC = KC.TD(
    LAY_2,
    KC.SPC,
    tap_time=120
)

'''
C O M B O S

‾‾‾‾‾‾‾‾‾‾‾‾‾
'''
combos = Combos()
keyboard.modules.append(combos)
combos.combos = [
    Chord((KC.Q, KC.W), KC.ESCAPE, timeout=50), # Q + D         = ESCAPE
    Chord((KC.I, KC.O), KC.BSPC, timeout=50),   # I + O         = BACKSPACE
    Chord((KC.O, KC.P), KC.DEL, timeout=50),    # O + P         = DELETE
    #Chord((KC.S, KC.D), LAY_2),                # S + D         = LAYER 2
    Chord((KC.D, KC.F), KC.SPC),                # D + F         = SPACE
    Chord((KC.K, KC.L), KC.ENT, timeout=50),    # K + L         = ENTER
    Chord((LAY_1, LAY_2), KC.SPC),            # LAY_1 + LAY_2 = LAY_3

    # Sequence((39, 10, 14), SM_X,    timeout=110, match_coord=True, per_key_timeout=True, fast_reset=False),
    Sequence((KC.SPC, KC.F, KC.C), M_COPY,  timeout=100, per_key_timeout=True, fast_reset=False),
    # Sequence((39, 10, 16), M_PASTE, timeout=110, match_coord=True, per_key_timeout=True, fast_reset=False),
    # Sequence((39, 10, 13), M_UNDO,  timeout=400, match_coord=True, per_keuy_timeout=False, fast_reset=False),
    # Sequence((39, 10, 30), M_L,     timeout=110, match_coord=True, per_key_timeout=False, fast_reset=False),
    # Sequence((39, 10, 5), M_T,      timeout=110, match_coord=True, per_key_timeout=False, fast_reset=False),
    # Sequence((39, 10, 33), M_N,     timeout=110, match_coord=True, per_key_timeout=False, fast_reset=False)
]

'''
K E Y M A P
‾‾‾‾‾‾‾‾‾‾‾‾‾
'''
keyboard.keymap = [
    # LAYER 0 - BASE #########################################################################################################################################
    #   ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐                           ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
    #   │         │    Q    │    W    │    E    │    R    │    T    │                           │    Y    │    U    │    I    │    O    │    P    │         │
    #   └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘                           └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘
    #   ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐                           ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
    #   │         │    A    │    S    │    D    │    F    │    G    │                           │    H    │    J    │    K    │    L    │    ;    │         │
    #   └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘                           └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘
    #   ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐                           ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
    #   │         │    Z    │    X    │    C    │    V    │    B    │                           │    N    │    M    │    ,    │    .    │    /    │         │
    #   └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘                           └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘
    #                                           ┌─────────┬─────────┬─────────┐       ┌─────────┬─────────┬─────────┐
    #                                           │  LAY_4  │  LAY_1  │  LSHFT  │       │  KC.SPC │  LAY_2  │  QUOT   │
    #                                           └─────────┴─────────┴─────────┘       └─────────┴─────────┴─────────┘
    [
        _______, KC.Q,    KC.W,    KC.E,    KC.R,    KC.T,                                              KC.Y,    KC.U,    KC.I,    KC.O,    KC.P,    _______,
        _______, KC.A,    KC.S,    KC.D,    KC.F,    G_OP,                                              KC.H,    KC.J,    KC.K,    KC.L,    KC.SCLN, _______,
        _______, KC.Z,    KC.X,    KC.C,    KC.V,    KC.B,                                              KC.N,    KC.M,    KC.COMM, KC.DOT,  KC.SLSH, _______,
                                            LAY_4,   KC.LSFT, LAY_1,                           LT_SPC_2, LT_ENT_3,   KC.QUOT,
     ],
    # LAYER 1 - EMPTY ########################################################################################################################################
    #   ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐                           ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
    #   │         │    1    │    2    │    3    │    4    │    5    │                           │    6    │    7    │    8    │    9    │    0    │         │
    #   └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘                           └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘
    #   ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐                           ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
    #   │         │    !    │    @    │    #    │    $    │    %    │                           │    ^    │    &    │    *    │    `    │    \    │         │
    #   └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘                           └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘
    #   ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐                           ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
    #   │         │    F1   │    F2   │    F3   │    F4   │    F5   │                           │    F6   │    F7   │    F8   │    F9   │   F10   │         │
    #   └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘                           └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘
    #                                           ┌─────────┬─────────┬─────────┐       ┌─────────┬─────────┬─────────┐
    #                                           │         │         │         │       │         │   F11   │   F12   │
    #                                           └─────────┴─────────┴─────────┘       └─────────┴─────────┴─────────┘
    [
        _______, KC.N1,   KC.N2,   KC.N3,   KC.N4,   KC.N5,                                             KC.N6,   KC.N7,   KC.N8,   KC.N9,   KC.N0,   _______,
        _______, KC.EXLM, KC.AT,   KC.HASH, KC.DLR,  KC.PERC,                                           KC.CIRC, KC.AMPR, KC.ASTR, KC.GRV,  KC.BSLS, _______,
        _______, KC.F1,   KC.F2,   KC.F3,   KC.F4,   KC.F5,                                             KC.F6,   KC.F7,   KC.F8,   KC.F9,   KC.F10,  _______,
                                            _______, _______, _______,                         _______, KC.F11,  KC.F12,
     ],
    # LAYER 2 - EMPTY ########################################################################################################################################
    #   ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐                           ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
    #   │         │   ESC   │         │         │         │   TAB   │                           │  BSPCE  │   DEL   │         │         │         │         │
    #   └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘                           └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘
    #   ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐                           ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
    #   │         │ SK_LSFT │ SK_LCTL │ SK_LALT │ SK_LGUI │         │                           │  ENTER  │  LEFT   │  DOWN   │   UP    │  DOWN   │         │
    #   └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘                           └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘
    #   ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐                           ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
    #   │         │         │         │         │         │         │                           │         │ SK_MEH  │ PGE DWN │ PGE UP  │         │         │
    #   └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘                           └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘
    #                                           ┌─────────┬─────────┬─────────┐       ┌─────────┬─────────┬─────────┐
    #                                           │         │         │         │       │         │         │         │
    #                                           └─────────┴─────────┴─────────┘       └─────────┴─────────┴─────────┘
    [
        _______, KC.ESC,  _______, _______, _______, KC.TAB,                                         _______, _______,  KC.BSPC, KC.DEL,  _______, _______,
        _______, SK_LSFT, SK_LCTL, SK_LALT, SK_LGUI, _______,                                        KC.ENT,  KC.LEFT,  KC.DOWN, KC.UP,   KC.RGHT, _______,
        _______, _______, _______, _______, _______, _______,                                        _______, SK_MEH,   KC.PGDN, KC.PGUP, _______, _______,
                                            _______, _______, _______,                      _______, _______, _______,
     ],
    # LAYER 3 - (SYMBOLS) ###########################################################################################################################
    #   ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐                           ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
    #   │         │         │         │         │    (    │    <    │                           │    >    │    )    │         │         │         │         │
    #   └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘                           └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘
    #   ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐                           ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
    #   │         │         │         │         │    {    │    [    │                           │    ]    │    }    │         │         │         │         │
    #   └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘                           └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘
    #   ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐                           ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
    #   │         │         │         │         │    _    │    -    │                           │    =    │    +    │         │         │         │         │
    #   └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘                           └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘
    #                                           ┌─────────┬─────────┬─────────┐       ┌─────────┬─────────┬─────────┐
    #                                           │         │         │         │       │         │         │         │
    #                                           └─────────┴─────────┴─────────┘       └─────────┴─────────┴─────────┘
    [
        _______, _______, _______, _______, KC.LPRN, KC.LABK,                                           KC.RABK, KC.RPRN, _______, _______, _______, _______,
        _______, _______, _______, _______, KC.LCBR, KC.LBRC,                                           KC.RBRC, KC.RCBR, _______, _______, _______, _______,
        _______, _______, _______, _______, KC.UNDS, KC.MINS,                                           KC.EQL,  KC.PLUS, _______, _______, _______, _______,
                                            _______, _______, _______,                         _______, _______, _______,
     ],
    # LAYER 4 - TRANS ########################################################################################################################################
    #   ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐                           ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
    #   │         │         │         │         │         │         │                           │         │         │         │         │         │         │
    #   └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘                           └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘
    #   ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐                           ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
    #   │         │         │         │         │         │         │                           │         │         │         │         │         │         │
    #   └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘                           └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘
    #   ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐                           ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
    #   │         │         │         │         │         │         │                           │         │         │         │         │         │         │
    #   └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘                           └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘
    #                                           ┌─────────┬─────────┬─────────┐       ┌─────────┬─────────┬─────────┐
    #                                           │         │         │         │       │         │         │         │
    #                                           └─────────┴─────────┴─────────┘       └─────────┴─────────┴─────────┘
    [
        _______, _______, _______, _______, _______, _______,                                           _______, _______, _______, _______, _______, _______,
        _______, _______, _______, SM_D,    _______, _______,                                           _______, _______, _______, _______, _______, _______,
        _______, M_UNDO,  M_CUT,   M_COPY,  M_PASTE, _______,                                           _______, _______, KC.MRWD, KC.MPLY, KC.MFFD, _______,
                                            _______, _______,  _______,                        _______, _______, _______,
     ],
    # LAYER 4 - TRANS ########################################################################################################################################
    #   ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐                           ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
    #   │         │         │         │         │         │         │                           │         │         │         │         │         │         │
    #   └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘                           └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘
    #   ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐                           ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
    #   │         │         │         │         │         │         │                           │         │         │         │         │         │         │
    #   └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘                           └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘
    #   ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐                           ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
    #   │         │         │         │         │         │         │                           │         │         │         │         │         │         │
    #   └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘                           └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘
    #                                           ┌─────────┬─────────┬─────────┐       ┌─────────┬─────────┬─────────┐
    #                                           │         │         │         │       │         │         │         │
    #                                           └─────────┴─────────┴─────────┘       └─────────┴─────────┴─────────┘
    [
        _______, _______, _______, _______, _______, _______,                                           _______, _______, _______, _______, _______, _______,
        _______, _______, _______, _______, _______, _______,                                           _______, _______, _______, _______, _______, _______,
        _______, _______, _______, _______, _______, _______,                                           _______, _______, _______, _______, _______, _______,
                                            _______, _______, _______,                         _______, _______, _______,
     ],
    # LAYER 5 - EMPTY ########################################################################################################################################
    #   ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐                           ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
    #   │  KC.NO  │  KC.NO  │  KC.NO  │  KC.NO  │  KC.NO  │  KC.NO  │                           │  KC.NO  │  KC.NO  │  KC.NO  │  KC.NO  │  KC.NO  │  KC.NO  │
    #   └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘                           └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘
    #   ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐                           ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
    #   │  KC.NO  │  KC.NO  │  KC.NO  │  KC.NO  │  KC.NO  │  KC.NO  │                           │  KC.NO  │  KC.NO  │  KC.NO  │  KC.NO  │  KC.NO  │  KC.NO  │
    #   └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘                           └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘
    #   ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐                           ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
    #   │  KC.NO  │  KC.NO  │  KC.NO  │  KC.NO  │  KC.NO  │  KC.NO  │                           │  KC.NO  │  KC.NO  │  KC.NO  │  KC.NO  │  KC.NO  │  KC.NO  │
    #   └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘                           └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘
    #                                           ┌─────────┬─────────┬─────────┐       ┌─────────┬─────────┬─────────┐
    #                                           │  KC.NO  │  KC.NO  │  KC.NO  │       │  KC.NO  │  KC.NO  │  KC.NO  │
    #                                           └─────────┴─────────┴─────────┘       └─────────┴─────────┴─────────┘
    [
        XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX,                                           XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX,
        XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX,                                           XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX,
        XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX,                                           XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX,
                                            XXXXXXX, XXXXXXX, XXXXXXX,                         XXXXXXX, XXXXXXX, XXXXXXX,
     ]
]

if __name__ == '__main__':
    keyboard.go()
